<script>
    /*jslint browser, devel, maxlen: 80, single, this, white*/
    /*global $, Game, google, window*/

    /****************************** Utilities *********************************/

    /**
     * @param {string} dollarStr - A dollar value in string format.
     * @return {string} The dollar value as a number.
     */
    function dollarStrToInt(dollarStr) {
        'use strict';
        if (typeof dollarStr === 'number') {
            return dollarStr;
        }
        if (dollarStr.match(/^\$?\d+(,\d{3})*(\.\d+)?$/)) {
            return Number(
                dollarStr.match(/\d+(,\d{3})*(\.\d+)?/)[0]
                .replace(',', ''));
        }
        if (dollarStr.match(/^\$\d+(,\d{3})*(\.\d+)?\sMillion$/)) {
            return Number(
                dollarStr.match(/\d+(,\d{3})*(\.\d+)?/)[0]
                .replace(',', '')) * 1000000;
        }
        return undefined;
    }

    /**
     * @param {number} num - The value to be formatted into USD.
     * @return {string} - Result formatted as USD.
     */
    function integerToUSD(num) {
        'use strict';
        var dividend = num;
        var divisor = 1000000;
        var quotient = (dividend / divisor) + 0;
        if (quotient >= 1) {
            return '$' + quotient + '&nbsp;Million';
        }
        return dividend.toLocaleString(
            'en-US', {
                style: 'currency',
                currency: 'USD'
            });
    }

    // TODO: give this fxn a better name
    /**
     * Doug Crockfords "Module Pattern" for reducing problems related to the
     * use of global variables.
     */
    var gameObjs = (function () {
        "use strict";
        var objects = {};

        function set(input) {
            objects = input;
        }

        function get() {
            return objects;
        }
        return {
            get: get,
            set: set
        };
    }());

    var playsObjs = (function () {
        "use strict";
        var objects = {};

        function set(input) {
            objects = input;
        }

        function get() {
            return objects;
        }
        return {
            get: get,
            set: set
        };
    }());

    var drawsObjs = (function () {
        "use strict";
        var objects = {};

        function set(input) {
            objects = input;
        }

        function get() {
            return objects;
        }
        return {
            get: get,
            set: set
        };
    }());

    /******************** Played Numbers object from array ********************/

    /**
     * Callback function for an array's--reduce--function.
     * @param {object} arr - The accumulator.
     * @param {object} data - Array of data for one set of played numbers.
     * @return {object} - Object containing one set of played numbers.
     */
    function processPlayedNumArr(arr, data) {
        'use strict';
        arr.push({
            numArr: data.slice(0, 5),
            ball: data[5] || '',
            bonus: data[6] || '',
            startDate: data[7] || Date.now(),
            endDate: data[8] || Date.now()
        });
        return arr;
    }

    function processPlayedNums(totalObj, curValObj) {
        'use strict';
        // slice off header
        var numArr = curValObj.data.slice(1).reduce(processPlayedNumArr, []);
        totalObj[curValObj.name] = numArr;
        return totalObj;
    }

    /********************* Drawn Numbers object from array ********************/

    function processDrawnNumArr(arr, data) {
        'use strict';
        var jackpot = dollarStrToInt(data[2]);
        var estJackpot = dollarStrToInt(data[6]);
        arr.push({
            drawDate: data[0],
            numArr: data[1].split('-'),
            jackpot: jackpot,
            ball: data[3] || '',
            bonus: data[4] || '',
            nextDrawDate: data[5] || '',
            estJackpot: estJackpot
        });
        return arr;
    }

    function processDrawnNums(totalObj, curValObj) {
        'use strict';
        var numArr = curValObj.data.slice(1).reduce(processDrawnNumArr, []);
        totalObj[curValObj.name] = numArr;
        return totalObj;
    }

    /********************** Game Rules object from array **********************/

    /**
     * Callback function
     * Used by the reduce function to map match-strings to their respective 
     * values.
     * @param {object} obj - An accumulator.
     * @param {object} curVal - A 1D array of match-strings and values.
     * @return {object} An object of match-strings mapped to values.
     */
    function getMatchValuesObj(obj, curVal) {
        'use strict';
        var matchVal = curVal[1].toLocaleString('en-US', {
            minimumIntegerDigits: 2
        });
        obj[matchVal] = curVal[2];
        return obj;
    }

    /**
     * @param {object} curVal - A 2D array of game rules names and values.
     * @return {Object} An instance of the Game class.
     */
    function classifyGameRules(curVal) {
        'use strict';
        var id = curVal.data[0][1];
        var name = curVal.data[1][1];
        var ball = curVal.data[2][1];
        var bonus = curVal.data[3][1];
        var threshold = dollarStrToInt(curVal.data[4][1]);
        var rules = curVal.data.slice(5).reduce(getMatchValuesObj, {});
        var game = new Game(name, id, ball, bonus, rules, threshold);
        return game;
    }

    /**************** Compare Drawn to Played Numbers Page ********************/

    /**
     * @param {string} gameName
     * @param {number} datePrimitive
     */
    function compareDrawnToPlayed(gameName, datePrimitive) {
        'use strict';
        var game = gameObjs.get()[gameName];
        var plays = playsObjs.get()[gameName];
        var draws = drawsObjs.get()[gameName];
        var date = new Date(datePrimitive);
        $('div').empty();
        $('div').append('<h1>LotteryWeb</h1>');
        $('div').append(
            '<ol class="breadcrumb">' +
            '<li class="breadcrumb-item">' +
            '<a href="javascript:home()">Home</a>' +
            '</li>' +
            '<li class="breadcrumb-item">' +
            '<a href="javascript:viewDrawings(\'' + gameName + '\')">' +
            'Drawings</a>' +
            '</li>' +
            '<li class="breadcrumb-item active">Winnings</li>' +
            '</ol>'
        );        
        $('div').append(
            '<table class="table table-condensed table-striped ' +
            'table-bordered"><caption></caption><thead></thead>' +
            '<tfoot></tfoot><tbody></tbody></table>');
        $('caption').append(
            gameName.replace(/\s/g, '&nbsp;') + '&nbsp;Results for ' +
            date.toLocaleDateString('en-US', {
                month: '2-digit',
                day: '2-digit',
                year: 'numeric'
            })
        );
        // TODO: base header on game chacteristics.  I.e., don't display bonus
        // ball header for games that don't use a bonus ball.
        $('thead').append(
            '<tr><th>Num1</th><th>Num2</th><th>Num3</th>' +
            '<th>Num4</th><th>Num5</th><th>' + game.ball + '</th>' +
            '<th>' + game.bonus.replace(' ', '&nbsp;') + '</th>' +
            '<th>Winnings!</th>' +
            '</tr>');
        // TODO: for one day list numbers played and check for matches with
        // the day's drawing.
        plays.forEach((curVal) => $('tbody').append(
            '<tr>' +
            '<td>' + curVal.numArr[0] + '</td>' +
            '<td>' + curVal.numArr[1] + '</td>' +
            '<td>' + curVal.numArr[2] + '</td>' +
            '<td>' + curVal.numArr[3] + '</td>' +
            '<td>' + curVal.numArr[4] + '</td>' +
            '<td>' + curVal.ball + '</td>' +
            '<td>' + curVal.bonus + '</td>' +
            '<td>$0</td>' +
            '</tr>'
        ));
        plays.startDate;
        plays.endDate;
        plays.ball;
        plays.bonus;
        draws.numArr;
        draws.drawDate;
        draws.ball;
        draws.bonus;
        draws.jackpot;
        $('tfoot').append(
            '<tr><th colspan="6"></th><th>Total:</th><th>$0</th></tr>');
    }

    /*************************** View Drawings Page ***************************/

    /**
     * @param {string} gameName
     */
    function viewDrawings(gameName) {
        'use strict';
        var tempArr = drawsObjs.get()[gameName]
            .slice(); // clone array to protect from reverse method
        var game = gameObjs.get()[gameName];
        $('div').empty();
        $('div').append('<h1>LotteryWeb</h1>');
        $('div').append(
            '<ol class="breadcrumb">' +
            '<li class="breadcrumb-item"><a href="javascript:home()">' +
            'Home</a></li>' +
            '<li class="breadcrumb-item active">Drawings</li>' +
            '</ol>'
        );
        $('div').append(
            '<table class="table table-hover table-bordered ' +
            'table-condensed"></table>');
        $('table').append('<caption></caption>');
        $('caption').html(gameName.replace(/\s/g, '&nbsp;') + '&nbsp;Drawings');
        $('table').append('<thead class="text-center"><tr></tr></thead>');
        $('table').append('<tbody class="text-center"></tbody>');
        $('thead tr').append(
            '<th class="text-left">Date</th><th>Num1</th><th>Num2</th>' +
            '<th>Num3</th><th>Num4</th><th>Num5</th>' +
            '<th>' + game.ball + '</th><th>' + game.bonus + '</th>' +
            '<th class="text-right">Jackpot</th>');
        tempArr.reverse().slice(0, 20).forEach(function (curVal, index) {
            var date = new Date(curVal.drawDate);
            $('tbody').append(
                '<tr title="Compare drawn numbers to played numbers" ' +
                'onClick="compareDrawnToPlayed(\'' + gameName + '\', ' +
                date.valueOf() + ')"></tr>');
            $('tbody tr:eq(' + index + ')').append(
                '<td class="text-left">' + date.toLocaleDateString(
                    'en-US', {
                        month: '2-digit',
                        day: '2-digit',
                        year: 'numeric'
                    }) + '</td>' +
                '<td>' + curVal.numArr[0] + '</td>' +
                '<td>' + curVal.numArr[1] + '</td>' +
                '<td>' + curVal.numArr[2] + '</td>' +
                '<td>' + curVal.numArr[3] + '</td>' +
                '<td>' + curVal.numArr[4] + '</td>' +
                '<td>' + curVal.ball + '</td>' +
                '<td>' + curVal.bonus + '</td>' +
                '<td class="text-right">' +
                integerToUSD(curVal.jackpot) + '</td>');
        });
    }

    /********************** Display Estimated Jackpots ************************/

    function displayEstJackpots(game, index) {
        'use strict';
        var tempObj = drawsObjs.get()[game.name].slice(-1)[0];
        var date = new Date(tempObj.nextDrawDate);
        if (index === 0) {
            $('table#estJackpotsTable tbody').empty();
        }
        $('table#estJackpotsTable tbody').append(
            '<tr title="View ' + game.name + ' Drawings"' +
            'onClick="viewDrawings(\'' + game.name + '\')">' +
            '<td>' + game.name + '</td>' +
            '<td>' + date.toLocaleDateString(
                'en-US', {
                    month: '2-digit',
                    day: '2-digit',
                    year: 'numeric'
                }) + '</td>' +
            '<td>' +
            integerToUSD(tempObj.estJackpot) +
            '</td>' +
            '</tr>');
    }

    /*********************** Display Recent Results ***************************/

    /**
     * This is used as the criteria for an array's--some--function.
     * @param {object} drawnNum is an object containing result data for one 
     * drawing.
     * @return {boolean}
     */
    function findActiveNum(playedNum) {
        'use strict';
        var drawnNum = this;
        var drawDate = new Date(drawnNum.drawDate);
        var startDate = new Date(playedNum.startDate);
        var endDate = new Date(playedNum.endDate);
        return startDate <= drawDate && drawDate <= endDate;
    }

    /**
     * This is used as the criteria for an array filter.
     * @param {object} drawnNum is an object containing result data for one 
     * drawing.
     * @return {boolean}
     */
    function activeNumber(drawnNum) {
        'use strict';
        var playedNumsArr = this;
        return playedNumsArr.some(findActiveNum, drawnNum);
    }

    /**
     * This is used as the criteria for an array filter.
     * @param {object} drawnNum is an object containing result data for one 
     * drawing.
     * @return {boolean}
     */
    function resultThreshold(drawnNum) {
        'use strict';
        var game = this;
        return game.threshold <= drawnNum.jackpot;
    }

    /**
     * @param {object} result is an object containing result data for one 
     * drawing.
     */
    function formatValidResults(result, index) {
        'use strict';
        var game = this.game;
        var playedArr = this.playedNumsArr;
        var date = new Date(result.drawDate);
        if (index === 0) {
            $('table#recentResultsTable tbody').empty();
        }
        $('table#recentResultsTable tbody').append(
            '<tr data-toggle="tooltip" title="View more ' + game.name +
            ' Winnings" onClick="compareDrawnToPlayed(\'' + game.name + '\', ' +
            date.valueOf() + ')">' +
            '<td>' + game.name + '</td>' +
            '<td>' + date.toLocaleDateString(
                'en-US', {
                    month: '2-digit',
                    day: '2-digit',
                    year: 'numeric'
                }) + '</td>' +
            '<td>' +
            integerToUSD(game.calcResult(playedArr, result)) +
            '</td>' +
            '</tr>');
    }

    /**
     * @param {object} game is an instance of the Game class
     */
    function displayRecentResults(game) {
        'use strict';
        drawsObjs.get()[game.name]
            .filter(resultThreshold, game)
            .filter(activeNumber, playsObjs.get()[game.name])
            .slice(-1)
            .forEach(
                formatValidResults, {
                    game: game,
                    playedNumsArr: playsObjs.get()[game.name]
                });
    }

    /************************** View Home Screen ******************************/

    /**
     *
     */
    function home() {
        'use strict';
        var gameRulesArr = Object.values(gameObjs.get());
        $('div').empty();
        $('div').append(
            '<h1>LotteryWeb</h1>' +
            '<ol class="breadcrumb">' +
            '<li class="breadcrumb-item active">Home</li>' +
            '</ol>' +
            '<table class="table table-bordered table-sm table-hover" ' +
            'id="estJackpotsTable">' +
            '<caption>Estimated Jackpots</caption>' +
            '<thead>' +
            '<tr>' +
            '<th>Game</th>' +
            '<th>Next Draw Date</th>' +
            '<th>Estimated Jackpot</th>' +
            '</tr>' +
            '</thead>' +
            '<tfoot></tfoot>' +
            '<tbody>' +
            '<tr>' +
            '</tr>' +
            '</tbody>' +
            '</table>' +
            '<table class="table table-bordered table-sm table-hover" ' +
            'id="recentResultsTable">' +
            '<caption>Recent Results</caption>' +
            '<thead>' +
            '<tr>' +
            '<th>Game</th>' +
            '<th>Draw Date</th>' +
            '<th>Winnings</th>' +
            '</tr>' +
            '</thead>' +
            '<tfoot></tfoot>' +
            '<tbody>' +
            '<tr>' +
            '</tr>' +
            '</tbody>' +
            '</table>'
        );
        gameRulesArr.forEach(displayEstJackpots);
        gameRulesArr.forEach(displayRecentResults);
    }

    /*************************** Main Function ********************************/

    /**
     * main
     * defines globals
     * @param {string} rawDataJsonStr - A stringified json object of data 
     * arrays.
     */
    function main(rawDataJsonStr) {
        'use strict';
        var rawDataJsonObj = JSON.parse(rawDataJsonStr);
        var gameRulesArr = rawDataJsonObj.gameRulesArr
            .map(classifyGameRules);
        var playedNumsObj = rawDataJsonObj.playedNumsArr
            .reduce(processPlayedNums, {});
        var drawnNumsObj = rawDataJsonObj.drawnNumsArr
            .reduce(processDrawnNums, {});
        var games = gameRulesArr.reduce(function (obj, game) {
            obj[game.name] = game;
            return obj;
        }, {});
        /** @global */
        gameObjs.set(games);
        /** @global */
        playsObjs.set(playedNumsObj);
        /** @global */
        drawsObjs.set(drawnNumsObj);
        gameRulesArr.forEach(displayEstJackpots);
        gameRulesArr.forEach(displayRecentResults);
    }

    function getDataAndLoadMain() {
        'use strict';
        // bootstrap requirement
        $('[data-toggle="tooltip"]').tooltip();
        // get data from spreadsheets then display
        google.script.run.withSuccessHandler(main).getData();
    }

    /***************************** jQuery functions ***************************/

    // jquery ready function
    $(getDataAndLoadMain);

    /**************************************************************************/
</script>