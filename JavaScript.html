<script>

/*jslint browser, devel, maxlen: 80, single, this, white*/
/*global $, google*/
/******************************************************************************/
function genericResult(gameRules, numsPlayed, numsDrawn) {
  'use strict';
  return 0;
}

var gameFxns = {
  'Mega Millions': genericResult,
  'Powerball': genericResult,
  'default': genericResult
};

/**
 * Game class definition
 */
function Game(gameName, gameRules, threshold) {
  'use strict';
  this.gameName = gameName;
  this.gameRules = gameRules;
  this.threshold = threshold;
}
Game.prototype.calcResult = function (numsPlayed, numsDrawn) {
  'use strict';
  var gameFxn = gameFxns[this.gameName] || gameFxns.default;
  return gameFxn(this.gameRules, numsPlayed, numsDrawn);
};

/******************************************************************************/

function processPlayedNumArr(arr, data) {
  'use strict';
  arr.push({
    numArr: data[0].split('-'),
    ball: data[1] || '',
    bonus: data[2] || '',
    startDate: data[3] || '',
    endDate: data[4] || ''
  });
  return arr;
}

function processPlayedNums(totalObj, curValObj) {
  'use strict';
  // slice off header
  var numArr = curValObj.data.slice(1).reduce(processPlayedNumArr, []);
  totalObj[curValObj.name] = numArr;
  return totalObj;
}

/******************************************************************************/

function processDrawnNumArr(arr, data) {
  'use strict';
  arr.push({
    drawDate: data[0],
    numArr: data[1].split('-'),
    jackpot: data[2] || '',
    ball: data[3] || '',
    bonus: data[4] || '',
    nextDrawDate: data[5] || '',
    estJackpot: data[6] || ''
  });
  return arr;
}

function processDrawnNums(totalObj, curValObj) {
  'use strict';
  var numArr = curValObj.data.slice(1).reduce(processDrawnNumArr, []);
  totalObj[curValObj.name] = numArr;
  return totalObj;
}

/******************************************************************************/

function rulesArrToObj(obj, curVal) {
  'use strict';
  var matchVal = curVal[1].toLocaleString('en-US', {
    minimumIntegerDigits: 2
  });
  obj[matchVal] = curVal[2];
  return obj;
}

function processGameRules(curVal) {
  'use strict';
  var name = curVal.data[1][1];
  var threshold = curVal.data[2][1];
  var rules = curVal.data.slice(3).reduce(rulesArrToObj, {});
  var game = new Game(name, rules, threshold);
  return game;
}

/******************************************************************************/

function displayEstJackpots(curVal) {
  'use strict';
  var drawnNumsObj = this;
  var tempObj = drawnNumsObj[curVal.gameName].slice(-1)[0];
  var date = new Date(tempObj.nextDrawDate);
  $('table#estJackpotsTable tbody').append('<tr>' +
    '<td>' + curVal.gameName + '</td>' +
    '<td>' + date.toLocaleDateString('en-US') + '</td>' +
    '<td>' + tempObj.estJackpot + '</td>' +
    '</tr>');
}

/******************************************************************************/

function displayRecentResults(curVal) {
'use strict';
  var playedNumsObj = this.playedNumsObj;
  var drawnNumsObj = this.drawnNumsObj;
  var date = new Date(drawnNumsObj[curVal.gameName][0].drawDate);
  var tempObj = {};
  //if (curVal.threshold !> drawnNumsObj.jackpot)
  $('table#recentResultsTable tbody').append('<tr>' +
    '<td>' + curVal.gameName + '</td>' +
    '<td>' + date.toLocaleDateString('en-US')  + '</td>' +
    '<td>' + drawnNumsObj[curVal.gameName][0].numArr[0] + '</td>' +
    '<td>' + drawnNumsObj[curVal.gameName][0].numArr[1] + '</td>' +
    '<td>' + drawnNumsObj[curVal.gameName][0].numArr[2] + '</td>' +
    '<td>' + drawnNumsObj[curVal.gameName][0].numArr[3] + '</td>' +
    '<td>' + drawnNumsObj[curVal.gameName][0].numArr[4] + '</td>' +
    '<td>' + drawnNumsObj[curVal.gameName][0].ball + '</td>' +
    '<td>' + curVal.calcResult(playedNumsObj, drawnNumsObj) + '</td>' +
    '</tr>');
}

/******************************************************************************/

/**
 * main is where most of the work is done
 * @param {string} rawDataJsonStr is a stringified json object
 *                                whose members are data arrays
 */
function main(rawDataJsonStr) {
  'use strict';
  var rawDataJsonObj = JSON.parse(rawDataJsonStr);
  var playedNumsObj = rawDataJsonObj.playedNumsArr
    .reduce(processPlayedNums, {});
  var drawnNumsObj = rawDataJsonObj.drawnNumsArr
    .reduce(processDrawnNums, {});
  var gameRulesArr = rawDataJsonObj.gameRulesArr
    .map(processGameRules);
  gameRulesArr.forEach(displayEstJackpots, drawnNumsObj);
  gameRulesArr.forEach(
  displayRecentResults, 
  {
  playedNumsObj: playedNumsObj,
  drawnNumsObj: drawnNumsObj
  }
  );
}

function getDataAndLoadMain() {
  'use strict';
  google.script.run.withSuccessHandler(main).getData();
}

/******************************************************************************/

// jquery ready function
$(getDataAndLoadMain);

</script>