<script type="application/ecmascript">
    /*jslint browser, maxlen: 80, this, white*/
    /*global $, Game, google, window*/

    //****************************** Utilities *********************************

    /**
     * @param {string} dollarStr - A dollar value in string format.
     * @return {string} The dollar value as a number.
     */
    function dollarStrToInt(dollarStr) {
        "use strict";
        if (typeof dollarStr === "number") {
            return dollarStr;
        }
        if (dollarStr.match(/^\$?\d+(,\d{3})*(\.\d+)?$/)) {
            return Number(
                dollarStr.match(/\d+(,\d{3})*(\.\d+)?/)[0]
                .replace(",", ""));
        }
        if (dollarStr.match(/^\$\d+(,\d{3})*(\.\d+)?\sMillion$/)) {
            return Number(
                dollarStr.match(/\d+(,\d{3})*(\.\d+)?/)[0]
                .replace(",", "")) * 1000000;
        }
        return undefined;
    }

    /**
     * @param {number} num - The value to be formatted into USD.
     * @return {string} - Result formatted as USD.
     */
    function integerToUSD(num) {
        "use strict";
        var dividend = num;
        var divisor = 1000000;
        var quotient = (dividend / divisor) + 0;
        if (quotient >= 40) {  // mm and pb minimum jp is $40MM
            return "$" + quotient + "&nbsp;Million";
        }
        return dividend.toLocaleString(
            "en-US", {
                style: "currency",
                currency: "USD",
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
    }

    //**************************** Module Patterns *****************************
    //
    // Doug Crockfords "Module Pattern" for reducing problems related to the
    // use of global variables.
    //
    //**************************************************************************

    //********************** Game Rules object from array **********************

    var gameObjs = (function () {
        "use strict";
        var objects = {};

        /**
         * Callback function
         * Used by the reduce function to map match-strings to their respective 
         * values.
         * @param {object} obj - An accumulator.
         * @param {object} curVal - A 1D array of match-strings and values.
         * @return {object} An object of match-strings mapped to values.
         */
        function getMatchValuesObj(obj, curVal) {
            var matchVal = curVal[1].toLocaleString("en-US", {
                minimumIntegerDigits: 2
            });
            obj[matchVal] = curVal[2];
            return obj;
        }

        /**
         * @param {object} curVal - A 2D array of game rules names and values.
         * @return {Object} An instance of the Game class.
         */
        function classifyGameRules(curVal) {
            var id = curVal.data[0][1];
            var name = curVal.data[1][1];
            var ball = curVal.data[2][1];
            var bonus = curVal.data[3][1];
            var threshold = dollarStrToInt(curVal.data[4][1]);
            var rules = curVal.data.slice(5).reduce(getMatchValuesObj, {});
            var game = new Game(name, id, ball, bonus, rules, threshold);
            return game;
        }

        function set(input) {
            objects = input.map(classifyGameRules).reduce(function (obj, game) {
                obj[game.name] = game;
                return obj;
            }, {});
        }

        function get() {
            return objects;
        }
        return {
            get: get,
            set: set
        };
    }());

    //******************** Played Numbers object from array ********************

    var playsObjs = (function () {
        "use strict";
        var objectsArr = [];

        /**
         * Callback function for an array's--reduce--function.
         * @param {object} arr - The accumulator.
         * @param {object} data - Array of data for one set of played numbers.
         * @return {object} - Object containing one set of played numbers.
         */
        function processPlayedNumArr(arr, data, index) {
            var numArr = data.slice(0, 6); // allow up to six numbers played
            if (index === 0) {
                // remove unused header fields
                numArr = numArr.filter((curVal) => curVal === "played_num");
            } else {
                // strip out empty strings, nulls, and undefs before
                // type conversion to number
                numArr = numArr.filter(
                        (curVal) => curVal !== null &&
                        curVal !== undefined &&
                        curVal !== "")
                    .map((curVal) => +curVal);
            }
            arr.push({
                numArr: numArr,
                ball: data[6] || "",
                bonus: data[7] || "",
                startDate: data[8] || Date.now(),
                endDate: data[9] || Date.now()
            });
            return arr;
        }

        function processPlayedNums(totalObj, curValObj) {
            var numArr = curValObj.data.reduce(processPlayedNumArr, []);
            totalObj[curValObj.name] = numArr;
            return totalObj;
        }

        function set(input) {
            objectsArr = input.reduce(processPlayedNums, {});
        }

        function get() {
            return objectsArr;
        }
        return {
            get: get,
            set: set
        };
    }());

    //********************* Drawn Numbers object from array ********************

    var drawsObjs = (function () {
        "use strict";
        var objectsArr = [];

        function processDrawnNumArr(arr, data) {
            var jackpot = dollarStrToInt(data[2]);
            var estJackpot = dollarStrToInt(data[6]);
            arr.push({
                drawDate: data[0],
                numArr: data[1].split("-").map((curVal) => +curVal),
                jackpot: jackpot,
                ball: data[3] || "",
                bonus: data[4] || "",
                nextDrawDate: data[5] || "",
                estJackpot: estJackpot
            });
            return arr;
        }

        function processDrawnNums(totalObj, curValObj) {
            var numArr = curValObj.data.slice(1).reduce(processDrawnNumArr, []);
            totalObj[curValObj.name] = numArr;
            return totalObj;
        }

        function set(input) {
            objectsArr = input.reduce(processDrawnNums, {});
        }

        function get() {
            return objectsArr;
        }

        function getOneDrawing(name, date) {
            var d = date.toISOString().slice(0, 10);
            return objectsArr[name]
                .filter((curVal) => curVal.drawDate.slice(0, 10) === d)[0];
        }
        return {
            get: get,
            getOneDrawing: getOneDrawing,
            set: set
        };
    }());

    //********************* Drawn Numbers object from array ********************
    
    var kittyObj = (function () {
        var balance = 0;

        function get() {
            return balance;
        }

        function set(data) {
            balance = data;
        }
        return {
            get: get,
            set: set
        };
    }());
    
    //**************************************************************************
    //**************************** Winnings! Page ******************************

    function formatAndCalcWins(curVal, index) {
        "use strict";
        var game = this.game;
        var drawing = this.drawing;
        var drawDate = new Date(drawing.drawDate);
        var endDate = new Date(curVal.endDate);
        var startDate = new Date(curVal.startDate);
        var matches = "";
        var match = 0;
        var total = 0;
        var strike = false;
        if (startDate > drawDate || drawDate > endDate) {
            $("tbody").append("<tr class=\"text-muted\" " +
                "title=\"Numbers not played\">");
            strike = true;
        } else {
            $("tbody").append("<tr>");
        }
        matches = curVal.numArr.filter(
                function (curVal) {
                    match = drawing.numArr.indexOf(curVal);
                    $("tbody tr:eq(" + index + ")")
                        .append("<td" +
                            ((match >= 0) ? " class=\"alert alert-success\">" :
                                ">") +
                            curVal.toString().padStart(2, "0") + "</td>");
                    return match >= 0;
                })
            .length
            .toString();
        if (drawing.ball) {
            if (drawing.ball === curVal.ball) {
                matches += "1";
                $("tbody tr:eq(" + index + ")")
                    .append("<td class=\"alert alert-success\">" +
                        curVal.ball.toString()
                        .padStart(2, "0") + "</td>");
            } else {
                matches += "0";
                $("tbody tr:eq(" + index + ")").append("<td>" +
                    curVal.ball.toString().padStart(2, "0") +
                    "</td>");
            }
        } else {
            matches = "0" + matches;
        }
        total = game.gameRules[matches] || 0;
        if (typeof total === "string") {
            if (total.toUpperCase() === "JACKPOT") {
                total = drawing.jackpot;
            }
        }
        if (curVal.bonus && curVal.bonus === drawing.bonus) {
            total *= drawing.bonus;
            $("tbody tr:eq(" + index + ")").append(
                "<td class=\"alert alert-success\">" +
                curVal.bonus + "</td>");
        } else if (drawing.bonus) {
            $("tbody tr:eq(" + index + ")")
                .append("<td>" + curVal.bonus + "</td>");
        }
        // calc win
        if (total > 0 && strike) {
            $("tbody tr:eq(" + index + ")")
                .append("<td class=\"alert alert-success text-right\">" +
                    integerToUSD(total).strike() + "</td>");
            total = 0;
        } else if (total > 0) {
            $("tbody tr:eq(" + index + ")")
                .append("<td class=\"alert alert-success text-right\">" +
                    integerToUSD(total) + "</td>");
        } else {
            $("tbody tr:eq(" + index + ")")
                .append("<td class=\"text-right\">" +
                    integerToUSD(total) + "</td>");
        }
        $("tbody tr:eq(" + index + ")").append("</tr>");
        return total;
    }

    /**
     * @param {string} gameName
     * @param {number} datePrimitive
     */
    function compareDrawnToPlayed(gameName, datePrimitive) {
        "use strict";
        var game = gameObjs.get()[gameName];
        var plays = playsObjs.get()[gameName];
        var total = 0;
        var date = new Date(datePrimitive);
        var drawing = drawsObjs.getOneDrawing(gameName, date);
        var cols = 0;
        $("div").empty();
        $("div").append("<h1>LotteryWeb</h1>");
        $("div").append(
            "<ol class=\"breadcrumb\">" +
            "<li class=\"breadcrumb-item\">" +
            "<a href=\"javascript:home()\">Home</a>" +
            "</li>" +
            "<li class=\"breadcrumb-item\">" +
            "<a href=\"javascript:viewDrawings('" + gameName + "')\">" +
            "Drawings</a>" +
            "</li>" +
            "<li class=\"breadcrumb-item active\">Winnings</li>" +
            "</ol>"
        );

        if (drawing.jackpot < game.threshold) {
            $("div").append("<h6 class=\"text-danger\">" +
                "Drawing jackpot too low.&nbsp;Game not played.</h6>");
        }

        $("div").append(
            "<table class=\"table table-condensed " +
            "table-sm table-bordered text-center\">" +
            "<caption></caption>" +
            "<thead></thead>" +
            "<tfoot></tfoot>" +
            "<tbody></tbody>" +
            "</table>");
        $("caption").append(
            gameName.replace(/\s/g, "&nbsp;") + "&nbsp;" +
            date.toLocaleDateString("en-US", {
                month: "2-digit",
                day: "2-digit",
                year: "numeric"
            })
        );
        $("thead").append("<tr>");
        plays[0].numArr
            .forEach(
                (ignore, index) => $("thead tr").append(
                    "<th>Num" + (index + 1) + "</th>"));
        cols = plays[0].numArr.length;
        if (game.ball) {
            cols += 1;
            $("thead tr").append("<th>" + game.ball + "</th>");
        }
        if (game.bonus) {
            cols += 1;
            $("thead tr").append("<th>" + game.bonus + "</th>");
        }
        $("thead tr").append("<th class=\"text-right\">Winnings!</th>");
        total = plays.slice(1).map(formatAndCalcWins, {
                game,
                drawing
            })
            .reduce((total, curVal) => total + curVal);
        $("tfoot").append(
            "<tr><th colspan=\"" + cols + "\"></th>" +
            "<th class=\"text-right\">Total:&nbsp;" +
            integerToUSD(total) +
            "</th></tr>");
    }

    //*************************** View Drawings Page ***************************

    /**
     * @param {string} gameName
     */
    function viewDrawings(gameName) {
        "use strict";
        var tempArr = drawsObjs.get()[gameName]
            .slice(); // clone array to protect from reverse method
        var game = gameObjs.get()[gameName];
        $("div").empty();
        $("div").append("<h1>LotteryWeb</h1>");
        $("div").append(
            "<ol class=\"breadcrumb\">" +
            "<li class=\"breadcrumb-item\"><a href=\"javascript:home()\">" +
            "Home</a></li>" +
            "<li class=\"breadcrumb-item active\">Drawings</li>" +
            "</ol>"
        );
        $("div").append(
            "<table class=\"table table-hover table-bordered " +
            "table-sm table-condensed\"></table>");
        $("table").append("<caption></caption>");
        $("caption").html(gameName.replace(/\s/g, "&nbsp;"));
        $("table").append("<thead class=\"text-center\"><tr></tr></thead>");
        $("table").append("<tbody class=\"text-center\"></tbody>");
        $("thead tr").append("<th class=\"text-left\">Date</th>");
        playsObjs.get()[gameName][0].numArr.forEach(function (ignore, index) {
            $("thead tr").append("<th>Num" + index + "</th>");
        });
        if (game.ball) {
            $("thead tr").append("<th>" +
                game.ball.toString().toString().padStart(2, "0") +
                "</th>");
        }
        if (game.bonus) {
            $("thead tr").append("<th>" + game.bonus + "</th>");
        }
        $("thead tr").append("<th class=\"text-right\">Jackpot</th>");
        tempArr.reverse().slice(0, 20).forEach(function (curVal, index) {
            var date = new Date(curVal.drawDate);
            $("tbody").append(
                "<tr title=\"Check for winnings\" " +
                "onClick=\"compareDrawnToPlayed('" + gameName + "', " +
                date.valueOf() + ")\"></tr>");
            $("tbody tr:eq(" + index + ")").append(
                "<td class=\"text-left\">" + date.toLocaleDateString(
                    "en-US", {
                        month: "2-digit",
                        day: "2-digit",
                        year: "numeric"
                    }) + "</td>");
            curVal.numArr.forEach(function (curVal) {
                $("tbody tr:eq(" + index + ")")
                    .append("<td>" +
                        curVal.toString().padStart(2, "0") +
                        "</td>");
            });
            if (game.ball) {
                $("tbody tr:eq(" + index + ")")
                    .append("<td>" +
                        curVal.ball.toString().padStart(2, "0") +
                        "</td>");
            }
            if (game.bonus) {
                $("tbody tr:eq(" + index + ")")
                    .append("<td>" + curVal.bonus + "</td>");
            }
            $("tbody tr:eq(" + index + ")").append("<td class=\"text-right\">" +
                integerToUSD(curVal.jackpot) + "</td>");
        });
    }

    //********************** Display Estimated Jackpots ************************

    function displayEstJackpots(gameRules, index) {
        "use strict";
        var tempObj = drawsObjs.get()[gameRules.name].slice(-1)[0];
        var date = new Date(tempObj.nextDrawDate);
        if (index === 0) {
            $("table#estJackpotsTable tbody").empty();
        }
        $("table#estJackpotsTable tbody").append(
            "<tr title=\"View " + gameRules.name + " Drawings\"" +
            "onClick=\"viewDrawings('" + gameRules.name + "')\">" +
            "<td class=\"text-left\">" + gameRules.name + "</td>" +
            "<td class=\"text-center\">" + date.toLocaleDateString(
                "en-US", {
                    month: "2-digit",
                    day: "2-digit",
                    year: "numeric"
                }) + "</td>" +
            "<td class=\"text-right\">" +
            integerToUSD(tempObj.estJackpot) +
            "</td>" +
            "</tr>");
    }

    //*********************** Display Recent Results ***************************

    /**
     * This is used as the criteria for an array"s--some--function.
     * @param {object} drawnNum is an object containing result data for one 
     * drawing.
     * @return {boolean}
     */
    function findActiveNum(playedNum) {
        "use strict";
        var drawnNum = this;
        var drawDate = new Date(drawnNum.drawDate);
        var startDate = new Date(playedNum.startDate);
        var endDate = new Date(playedNum.endDate);
        return startDate <= drawDate && drawDate <= endDate;
    }

    /**
     * This is used as the criteria for an array filter.
     * @param {object} drawnNum is an object containing result data for one 
     * drawing.
     * @return {boolean}
     */
    function activeNumber(drawnNum) {
        "use strict";
        var playedNumsArr = this;
        return playedNumsArr.some(findActiveNum, drawnNum);
    }

    /**
     * This is used as the criteria for an array filter.
     * @param {object} drawnNum is an object containing result data for one 
     * drawing.
     * @return {boolean}
     */
    function resultThreshold(drawnNum) {
        "use strict";
        var game = this;
        if (game.threshold === undefined) {
            return true;
        }
        return game.threshold <= drawnNum.jackpot;
    }

    /**
     * @param {object} result is an object containing result data for one 
     * drawing.
     */
    function formatValidResults(result) {
        "use strict";
        var game = this.game;
        var playedArr = this.playedNumsArr.slice(-1);
        var date = new Date(result.drawDate);
        $("table#recentResultsTable tbody").append(
            "<tr data-toggle=\"tooltip\" title=\"View details\"" +
            " onClick=\"compareDrawnToPlayed('" + game.name + "', " +
            date.valueOf() + ")\">" +
            "<td class=\"text-left\">" + game.name + "</td>" +
            "<td class=\"text-center\">" + date.toLocaleDateString(
                "en-US", {
                    month: "2-digit",
                    day: "2-digit",
                    year: "numeric"
                }) + "</td>" +
            "<td class=\"text-right\">" +
            integerToUSD(game.calcResult(playedArr, result)) +
            "</td>" +
            "</tr>");
    }

    /**
     * @param {object} game is an instance of the Game class
     */
    function displayRecentResults(gameRawObj) {
        "use strict";
        var name = gameRawObj.name;
        var gameRules = gameObjs.get()[name];
        var playsArr = playsObjs.get()[name].slice(1); // remove header
        var drawsArr = drawsObjs.get()[name];
        var byDateArr = drawsArr.filter(activeNumber, playsArr);
        var byThresholdArr = byDateArr.filter(resultThreshold, gameRules);
        byThresholdArr.slice(-1) // display only last played per game
            .forEach(
                formatValidResults, {
                    game: gameRules,
                    playedNumsArr: playsArr
                });
    }

    //************************** View Home Screen ******************************

    /**
     *
     */
    function home() {
        "use strict";
        var gameRulesArr = Object.values(gameObjs.get());
        $("div").empty();
        $("div").append(
            "<h1>LotteryWeb</h1>" +
            "<ol class=\"breadcrumb\">" +
            "<li class=\"breadcrumb-item active\">Home</li>" +
            "</ol>" +
            "<table class=\"table table-bordered table-condensed table-sm " +
            "table-hover\" id=\"estJackpotsTable\">" +
            "<caption>Estimated Jackpots</caption>" +
            "<thead>" +
            "<tr>" +
            "<th class=\"text-left\">Game</th>" +
            "<th class=\"text-center\">Next Draw Date</th>" +
            "<th class=\"text-right\">Estimated Jackpot</th>" +
            "</tr>" +
            "</thead>" +
            "<tfoot></tfoot>" +
            "<tbody>" +
            "<tr>" +
            "</tr>" +
            "</tbody>" +
            "</table>" +
            "<table class=\"table table-bordered table-condensed table-sm " +
            "table-hover\" id=\"recentResultsTable\">" +
            "<caption>Recent Results</caption>" +
            "<thead>" +
            "<tr>" +
            "<th class=\"text-left\">Game</th>" +
            "<th class=\"text-center\">Draw Date</th>" +
            "<th class=\"text-right\">Winnings</th>" +
            "</tr>" +
            "</thead>" +
            "<tfoot></tfoot>" +
            "<tbody>" +
            "<tr>" +
            "</tr>" +
            "</tbody>" +
            "</table>"
        );
        gameRulesArr.forEach(displayEstJackpots);
        
        // show kitty balance
        $("table#estJackpotsTable tfoot").append(
        "<tr><th colspan=\"2\" class=\"text-right\">Kitty Balance:</th>" +
        "<th class=\"text-right\">" + integerToUSD(kittyObj.get()) + 
        "</th></tr>");
        
        gameRulesArr.forEach(displayRecentResults);
    }

    //*************************** Main Function ********************************

    /**
     * main
     * defines globals
     * @param {string} rawDataJsonStr - A stringified json object of data 
     * arrays.
     */
    function main(rawDataJsonStr) {
        "use strict";
        var rawDataJsonObj = JSON.parse(rawDataJsonStr);

        /** @global */
        gameObjs.set(rawDataJsonObj.gameRulesArr);
        /** @global */
        playsObjs.set(rawDataJsonObj.playedNumsArr);
        /** @global */
        drawsObjs.set(rawDataJsonObj.drawnNumsArr);
        /** @global */
        kittyObj.set(rawDataJsonObj.kittyArr[0][5]);

        rawDataJsonObj.gameRulesArr.forEach(displayEstJackpots);
    
        $("table#recentResultsTable tbody").empty(); // clear the spinners
    
        // show kitty balance
        $("table#estJackpotsTable tfoot").append(
        "<tr><th colspan=\"2\" class=\"text-right\">Kitty Balance:</th>" +
        "<th class=\"text-right\">" + integerToUSD(kittyObj.get()) + 
        "</th></tr>");
    
        rawDataJsonObj.gameRulesArr.forEach(displayRecentResults);
    }

    function getDataAndLoadMain() {
        "use strict";
        // bootstrap requirement
        $("[data-toggle=\"tooltip\"]").tooltip();
        // get data from spreadsheets then display
        google.script.run.withSuccessHandler(main).getData();
    }

    //***************************** jQuery functions ***************************

    // jquery ready function
    $(getDataAndLoadMain);

    //**************************************************************************
</script>